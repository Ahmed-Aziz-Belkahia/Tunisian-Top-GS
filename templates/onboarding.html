{% extends "base.html" %}
{% load static %}

{% block head %}
  <link rel="stylesheet" href="{% static "styles/Onboarding.css" %}">
  <title>Onboarding - Tunisian Top Gs</title>
{% endblock head %}

{% block main %}
<div class="all-container">
  <div class="toploadingbar">
    <a href="{% url "home" %}">
      <svg class="x-icon" id="quit-button" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18" fill="none">
        <path d="M16.57 1L1 16.57M1 1L16.57 16.57" stroke="#BABABA" stroke-width="2" stroke-miterlimit="10" />
      </svg>
    </a>
    <div class="loading-top">
      <div class="loading-fill"></div>
    </div>
    <span class="percentage">0%</span>
  </div>

  {% if questions %}
    <div class="container" id="question-container">
      {% for question in questions %}
      <div class="question-step" data-id="{{ question.id }}" data-index="{{ forloop.counter }}" {% if not forloop.first %}style="display: none;"{% endif %}>
        {% if question.question_type == "images" %}
          <!-- Existing image question code -->
        {% elif question.question_type == "input" %}
          <span class="question-text">{{ question.question }}</span>
          <input type="text" class="input-answer" data-id="{{ question.id }}" data-index="{{ forloop.counter }}">
          <button class="continue" id="continue{{ forloop.counter }}" data-next="question{{ forloop.counter|add:1 }}" data-question-index="{{ forloop.counter0 }}">Continue</button>
        {% else %}
          <!-- Existing other question type code -->
        {% endif %}
      </div>
      {% endfor %}
      <!-- Finish step -->
      <div class="question-step" id="finish-step" data-index="{{ questions|length|add:1 }}" style="display: none;">
        <span class="question-text">You have completed all the questions!</span>
        <button id="finishQuiz">Finish</button>
      </div>
    </div>
  {% else %}
    <div class="no-onboarding">
      <p>No onboarding content available.</p>
      <button onclick="location.reload()">Refresh</button>
    </div>
  {% endif %}
</div>

<div id="modal" class="modal">
  <div class="modal-content">
    <span>Are you sure you want to skip the quiz?</span>
    <button id="modal-yes">Yes</button>
    <button id="modal-no">No</button>
  </div>
</div>
{% endblock main %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const totalQuestions = {{ questions|length }};
    let answers = new Array(totalQuestions).fill(null);

    document.querySelectorAll('.dark-option').forEach(option => {
      option.addEventListener('click', function() {
        const questionIndex = parseInt(this.closest('.question-step').getAttribute('data-index')) - 1;
        const optionId = parseInt(this.getAttribute('data-id'));

        // Mark the selected option
        document.querySelectorAll(`[data-index="${questionIndex + 1}"] .dark-option`).forEach(opt => {
          opt.classList.remove('selected');
        });
        this.classList.add('selected');

        // Store the selected option's id
        answers[questionIndex] = optionId;
      });
    });

    document.querySelectorAll('.input-answer').forEach(input => {
      input.addEventListener('input', function() {
        const questionIndex = parseInt(this.closest('.question-step').getAttribute('data-index')) - 1;
        const inputValue = this.value.trim();
        answers[questionIndex] = inputValue;
      });
    });

    document.querySelectorAll('.continue').forEach(button => {
      button.addEventListener('click', function() {
        const currentQuestionIndex = parseInt(this.closest('.question-step').getAttribute('data-index')) - 1;
        const nextQuestionIndex = parseInt(this.getAttribute('data-next').replace('question', '')) - 1;

        // Ensure an option is selected before moving to the next question
        if (answers[currentQuestionIndex] !== null && answers[currentQuestionIndex] !== '') {
          // Hide current question and show the next one
          document.querySelector(`.question-step[data-index="${currentQuestionIndex + 1}"]`).style.display = 'none';
          if (document.querySelector(`.question-step[data-index="${nextQuestionIndex + 1}"]`)) {
            document.querySelector(`.question-step[data-index="${nextQuestionIndex + 1}"]`).style.display = 'block';
          }
          // Update progress
          const progress = Math.round(((currentQuestionIndex + 1) / totalQuestions) * 100);
          document.querySelector('.loading-fill').style.width = progress + '%';
          document.querySelector('.percentage').textContent = progress + '%';
        } else {
          alert('Please complete the current step to continue.');
        }
      });
    });

    document.getElementById('finishQuiz').addEventListener('click', function() {
      if (answers.includes(null) || answers.includes('')) {
        alert('Please answer all questions before finishing the quiz.');
      } else {
        ajaxRequest("POST", "{% url 'onboarding' %}", JSON.stringify({ answers: answers }), function(response) {
          if (response.success) {
            window.location.href = '{% url "home" %}';
          } else {
            alert('There was an error submitting your answers. Please try again.');
          }
        }, function(error) {
          alert('An error occurred: ' + error.responseText);
        }, true, "Submitting Onboarding Answers");
      }
    });
  });
</script>
{% endblock scripts %}
